<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>Speech Demo</title>
</head>
<body>
  <h2>ğŸ¤ å³æ™‚ç¿»è­¯æ¸¬è©¦</h2>

  <div>
    <label>è¨ªå®¢å¯†ç¢¼ï¼š</label>
    <input id="pass" type="password" placeholder="è¼¸å…¥å¯†ç¢¼">
    <button id="btnAuth">è§£é–</button>
    <span id="gateStatus">locked</span>
  </div>

  <div style="margin-top:8px;">
    <button id="btnStart" disabled>é–‹å§‹</button>
    <button id="btnStop" disabled>åœæ­¢</button>
    <span id="status">idle</span>
  </div>

  <pre id="out" style="background:#111;color:#0f0;padding:12px;min-height:120px;white-space:pre-wrap;"></pre>

  <!-- Azure Speech SDK -->
  <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
  <!-- Demo script -->
  <script>
    const TOKEN_URL = "https://api.52hzfan.com/api/token";
    const speechSDK = window.SpeechSDK;
    const $out = document.getElementById('out');
    const $status = document.getElementById('status');
    const $btnStart = document.getElementById('btnStart');
    const $btnStop = document.getElementById('btnStop');
    const $btnAuth = document.getElementById('btnAuth');
    const $gateStatus = document.getElementById('gateStatus');
    const $pass = document.getElementById('pass');

    let recognizer = null;
    let unlocked = false;

    function log(line) {
      $out.textContent += line + '\n';
      $out.scrollTop = $out.scrollHeight;
    }

    async function getToken(password) {
      const r = await fetch(TOKEN_URL, {
        headers: { "X-Access-Key": password }
      });
      if (!r.ok) throw new Error("token failed " + r.status);
      return r.json();
    }

    $btnAuth.onclick = async () => {
      try {
        await getToken($pass.value);
        unlocked = true;
        $gateStatus.textContent = "unlocked";
        $btnStart.disabled = false;
      } catch {
        unlocked = false;
        $gateStatus.textContent = "locked";
        $btnStart.disabled = true;
        alert("å¯†ç¢¼éŒ¯èª¤æˆ–å·²éæœŸ");
      }
    };

    $btnStart.onclick = async () => {
      if (!unlocked) { alert('è«‹å…ˆè¼¸å…¥å¯†ç¢¼'); return; }
      $btnStart.disabled = true; $btnStop.disabled = false; $status.textContent = 'connecting...';

      try {
        // 1) å– token
        const { token, region } = await getToken($pass.value);

        // 2) ç¿»è­¯è¨­å®šï¼šä¾†æº=ä¸­æ–‡ï¼ˆå°ç£ï¼‰ï¼Œç›®æ¨™=è‹±æ–‡/æ—¥æ–‡
        const cfg = SpeechSDK.SpeechTranslationConfig.fromAuthorizationToken(token, region);
        cfg.speechRecognitionLanguage = "zh-TW";   // ä½ è¦è¬›ä¸­æ–‡
        ["en", "ja"].forEach(t => cfg.addTargetLanguage(t));  // åªæ”¾ en/ja

        // 3) éº¥å…‹é¢¨
        const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();

        // 4) å»ºç«‹ç¿»è­¯ recognizerï¼ˆå…©å€‹åƒæ•¸ï¼‰
        recognizer = new SpeechSDK.TranslationRecognizer(cfg, audioConfig);

        // è¨ºæ–·äº‹ä»¶ï¼ˆå¯çœ‹åˆ°æ˜¯å¦æœ‰æ‹¾éŸ³ï¼‰
        recognizer.sessionStarted = () => console.log("[session] started");
        recognizer.speechStartDetected = () => console.log("[speech] start");
        recognizer.speechEndDetected = () => console.log("[speech] end");

        // å³æ™‚å­—å¹•ï¼ˆä¸­æ–‡åŸæ–‡ï¼‰ï¼‹ç¿»è­¯ï¼ˆè‹±/æ—¥ï¼‰
        recognizer.recognizing = (s, e) => {
          $status.textContent = "listening...";
          const tr = e.result.translations; // Map
          const en = tr.get("en") || "";
          const ja = tr.get("ja") || "";
          log(`[partial][åŸæ–‡] ${e.result.text}`);
          if (en) log(`          [è‹±] ${en}`);
          if (ja) log(`          [æ—¥] ${ja}`);
        };

        recognizer.recognized = (s, e) => {
          const tr = e.result.translations;
          const en = tr.get("en") || "";
          const ja = tr.get("ja") || "";
          log(`[final][åŸæ–‡] ${e.result.text}`);
          if (en) log(`        [è‹±] ${en}`);
          if (ja) log(`        [æ—¥] ${ja}`);
        };

        recognizer.canceled = (s, e) => {
          log(`[error] reason=${e.reason} details=${e.errorDetails||""}`);
          stop();
        };

        recognizer.startContinuousRecognitionAsync();
        console.log("[start] translation started (src=zh-TW â†’ en/ja)");
      } catch (err) {
        console.error("[start] failed", err);
        $status.textContent = "error";
        $btnStart.disabled = false; $btnStop.disabled = true;
        log(`[fatal] ${err.message || err}`);
      }
    };

    function stop() {
      if (!recognizer) return;
      recognizer.stopContinuousRecognitionAsync(() => {
        $status.textContent = "stopped";
        $btnStart.disabled = false; $btnStop.disabled = true;
      });
      recognizer = null;
    }

    $btnStop.onclick = stop;
  </script>
</body>
</html>
